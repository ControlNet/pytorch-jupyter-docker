name: Release

on:
  push:
    branches:
      - master
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # daily at 03:00 UTC

jobs:

  discover-tags:
    name: Discover PyTorch runtime tags
    runs-on: ubuntu-latest
    outputs:
      builds: ${{ steps.discover.outputs.builds }}
      latest_runtime: ${{ steps.discover.outputs.latest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Collect tags
        id: discover
        run: python scripts/discover_tags.py

  dockerhub-release:
    name: Dockerhub Release
    runs-on: ubuntu-latest
    needs: discover-tags

    strategy:
      matrix:
        build: ${{ fromJson(needs.discover-tags.outputs.builds) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image
        uses: docker/build-push-action@v4
        if: matrix.build.exists == false || github.event_name == 'workflow_dispatch'
        with:
          context: .
          push: true
          build-args: |
            PYTORCH_TAG=${{ matrix.build.tag }}
          tags: controlnet/pytorch-jupyter:${{ matrix.build.tag }}

      - name: Tag latest
        if: matrix.build.push_latest == true
        run: |
          docker buildx imagetools create \
            --tag controlnet/pytorch-jupyter:latest \
            controlnet/pytorch-jupyter:${{ matrix.build.tag }}

      - name: Prepare summary line
        if: always()
        run: |
          status_raw="${{ job.status }}"
          tag="${{ matrix.build.tag }}"
          exists="${{ matrix.build.exists }}"
          will_build="${{ matrix.build.will_build }}"
          latest="${{ matrix.build.push_latest }}"

          # decide status
          if [ "$will_build" = "false" ]; then
            status="â­ï¸ skipped"
          elif [ "$status_raw" = "Success" ] || [ "$status_raw" = "Succeeded" ]; then
            status="âœ… success"
          else
            status="âŒ failure"
          fi

          icon_exists=$([ "$exists" = "true" ] && echo "âœ”ï¸ yes" || echo "âž– no")
          icon_build=$([ "$will_build" = "true" ] && echo "ðŸŸ¢ build" || echo "â­ï¸ skip")
          icon_latest=$([ "$latest" = "true" ] && echo "â­ yes" || echo "")

          echo "| ${tag} | ${icon_exists} | ${icon_build} | ${icon_latest} | ${status} |" > summary_line.txt

      - name: Upload summary line
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: summary-${{ matrix.build.tag }}
          path: summary_line.txt

  summarize:
    name: Summarize build matrix
    runs-on: ubuntu-latest
    needs: [discover-tags, dockerhub-release]
    steps:
      - name: Download summary lines
        uses: actions/download-artifact@v4
        with:
          path: summary_lines
          pattern: summary-*
          merge-multiple: true

      - name: Write summary table
        run: |
          echo "| Tag | Exists | Will Build | Latest | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "| --- | --- | --- | --- | --- |" >> "$GITHUB_STEP_SUMMARY"
          cat summary_lines/summary-*/summary_line.txt 2>/dev/null >> "$GITHUB_STEP_SUMMARY"
